<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Deploy com Ubuntu 14.04 ou Debian 8 - Mapas Culturais</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Deploy com Ubuntu 14.04 ou Debian 8";
    var mkdocs_page_input_path = "mc_deploy.md";
    var mkdocs_page_url = "/mc_deploy/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Mapas Culturais</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Sobre o Mapas Culturais</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Instalação</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Deploy com Ubuntu 14.04 ou Debian 8</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#mapas-culturais-deploy">Mapas Culturais &gt; Deploy</a></li>
                
                    <li><a class="toctree-l4" href="#1-instalando-os-pacotes-necessarios-para-o-funcionamento-do-sistema">1. Instalando os pacotes necessários para o funcionamento do sistema</a></li>
                
                    <li><a class="toctree-l4" href="#2-clonando-o-repositorio">2. Clonando o repositório</a></li>
                
                    <li><a class="toctree-l4" href="#3-criando-banco-de-dados">3. Criando banco de dados</a></li>
                
                    <li><a class="toctree-l4" href="#4-configurando-a-aplicacao">4. Configurando a aplicação</a></li>
                
                    <li><a class="toctree-l4" href="#5-concluindo">5. Concluindo</a></li>
                
                    <li><a class="toctree-l4" href="#6-pos-instalacao-criando-super-admin">6. Pós-instalação - Criando super admin</a></li>
                
                    <li><a class="toctree-l4" href="#7-pos-instalacao-processo-de-autenticacao">7. Pós-instalação - Processo de autenticação</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_deploy_theme/">Ativação do tema</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_deploy_shapefiles/">Inserção de Shapefiles</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Configurações</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_config_authentication/">Autenticação</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_config_api/">API</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Guia do desenvolvedor</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_developer_guide/">Guia do desenvolvedor</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_developer_docker_enviroment/">Docker Enviroment</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_developer_theme/">Criação de novo tema</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_developer_entities/">Entidades</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../mc_developer_keywords/">Palavras-chave</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Mapas Culturais</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Instalação &raquo;</li>
        
      
    
    <li>Deploy com Ubuntu 14.04 ou Debian 8</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="mapas-culturais-deploy">Mapas Culturais &gt; Deploy</h1>
<p>Neste guia faremos o deploy do Mapas Culturais utilizando o nginx + php-fpm em um sistema Ubuntu 14.04 Server recém instalado somente com o OpenSSH Server. O Banco de dados e a aplicação rodarão no mesmo servidor e usuário.</p>
<p>Não abordaremos as configurações de autenticação, seja com ID da Cultura, seja com Login Cidadão. Ao final do guia teremos a aplicação rodando com o método de autenticação Fake.</p>
<p>As linhas que começam com <strong>mapas@server$</strong> são executadas com o usuário criado para rodar a aplicação e as linhas que começam com <strong>root@server#</strong> são executadas com o usuário <em>root</em>.</p>
<h3 id="1-instalando-os-pacotes-necessarios-para-o-funcionamento-do-sistema">1. Instalando os pacotes necessários para o funcionamento do sistema</h3>
<pre><code class="BASH">// Atualize os repositórios de referência de sua máquina
root@server# apt-get update

// Instale as dependências diversas
root@server# apt-get install git curl npm ruby

// Instale a versão stable mais nova do nodejs
root@server# curl -sL https://deb.nodesource.com/setup_4.x | sudo -E bash -
root@server# sudo apt-get install -y nodejs

// Instale o postgresql e postgis
root@server# apt-get install postgresql postgresql-contrib postgis postgresql-9.3-postgis-2.1 postgresql-9.3-postgis-2.1-scripts

// Instale o php, php-fpm e extensões do php utilizadas no sistema
root@server# apt-get install php5 php5-gd php5-cli php5-json php5-curl php5-pgsql php-apc php5-fpm

// Instale o nginx
root@server# apt-get install nginx

// Instale o gerenciador de dependências do PHP Composer
root@server# curl -sS https://getcomposer.org/installer | php
root@server# mv composer.phar /usr/local/bin/composer.phar
</code></pre>

<p>No Ubuntu o executável do NodeJS se chama <em>nodejs</em>, porém para o correto funcionamento das bibliotecas utilizadas, o executáel deve se chamar <em>node</em>. Para isto criamos um link simbólico com o comando abaixo</p>
<pre><code class="BASH">root@server# update-alternatives --install /usr/bin/node node /usr/bin/nodejs 10
</code></pre>

<p>Instalando os minificadores de código Javascript e CSS: uglify-js, uglifycss e autoprefixer</p>
<pre><code class="BASH">root@server# npm install -g uglify-js uglifycss autoprefixer
</code></pre>

<p>Instalando o SASS, utilizado para compilar os arquivos CSS</p>
<pre><code class="BASH">root@server# gem install sass
</code></pre>

<h3 id="2-clonando-o-repositorio">2. Clonando o repositório</h3>
<p>Primeiro vamos criar o usuário que rodará a aplicação e que será proprietário do banco de dados, definindo sua home para <em>/srv</em> e colocando-o no grupo <em>www-data</em>.</p>
<pre><code class="BASH">root@server# useradd -G www-data -d /srv/mapas -m mapas
</code></pre>

<p>Vamos clonar o repositório usando o usuário criando, então precisamos primeiro "logar" com este usuário.</p>
<pre><code class="BASH">root@server# su - mapas
</code></pre>

<p>Agora faça o clone do repositório.</p>
<pre><code class="BASH">mapas@server$ git clone https://github.com/hacklabr/mapasculturais.git
</code></pre>

<p>E alterne para o branch v2. Se for uma instalação de teste, você pode pular esta etapa.</p>
<pre><code class="BASH">mapas@server$ cd mapasculturais
mapas@server$ git checkout v2
</code></pre>

<p>Agora vamos instalar as dependências de PHP utilizando o Composer.</p>
<pre><code class="BASH">mapas@server$ cd ~/mapasculturais/src/protected/
mapas@server$ composer.phar install
</code></pre>

<h3 id="3-criando-banco-de-dados">3. Criando banco de dados</h3>
<p>Vamos voltar ao usuário <em>root</em> para criar o banco de dados.</p>
<pre><code class="BASH">root@server# exit
mapas@server$ 
</code></pre>

<p>Primeiro vamos criar o usuário no banco de dados com o mesno nome do usuário do sistema</p>
<pre><code class="BASH">root@server# sudo -u postgres psql -c &quot;CREATE USER mapas&quot;
</code></pre>

<p>Agora vamos criar a base de dados para a aplicação com o mesmo nome do usuário</p>
<pre><code class="BASH">root@server# sudo -u postgres createdb --owner mapas mapas
</code></pre>

<p>Criar as extensões necessárias no banco</p>
<pre><code class="BASH">root@server# sudo -u postgres psql -d mapas -c &quot;CREATE EXTENSION postgis;&quot;
root@server# sudo -u postgres psql -d mapas -c &quot;CREATE EXTENSION unaccent;&quot;
</code></pre>

<p>Volte a "logar" com o usuário criado e importar o esquema da base de dados</p>
<pre><code class="BASH">root@server# su - mapas
mapas@server$ psql -f mapasculturais/db/schema.sql
</code></pre>

<h3 id="4-configurando-a-aplicacao">4. Configurando a aplicação</h3>
<h4 id="configuracao-do-mapas-culturais">Configuração do Mapas Culturais</h4>
<p>Primeiro crie um arquivo de configuração copiando o arquivo de template de configuração. Este arquivo está preparado para funcionar com este guia, utilizando o método de autenticação Fake.</p>
<pre><code class="BASH">mapas@server$ cp mapasculturais/src/protected/application/conf/config.template.php mapasculturais/src/protected/application/conf/config.php
</code></pre>

<h4 id="criando-as-pastas-necessarias">Criando as pastas necessárias</h4>
<p>Como root, crie a pasta para os arquivos de log:</p>
<pre><code class="BASH">$ exit
root@server# mkdir /var/log/mapasculturais
root@server# chown mapas:www-data /var/log/mapasculturais
</code></pre>

<p>Com o usuário criado, crie a pasta para os assets e para os uploads:</p>
<pre><code class="BASH">root@server# su - mapas
mapas@server$ mkdir mapasculturais/src/assets
mapas@server$ mkdir mapasculturais/src/files
</code></pre>

<h4 id="configuracao-do-nginx">Configuração do nginx</h4>
<p>Precisamos criar o <em>virtual host</em> do nginx para a aplicação. Para isto crie, como root, o arquivo <strong>/etc/nginx/sites-available/mapas.conf</strong> com o conteudo abaixo:</p>
<pre><code>server {
  set $site_name meu.dominio.gov.br;

  listen *:80;
  server_name  meu.dominio.gov.br;
  access_log   /var/log/mapasculturais/nginx.access.log;
  error_log    /var/log/mapasculturais/nginx.error.log;

  index index.php;
  root  /srv/mapas/mapasculturais/src/;

  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  location ~ /files/.*\.php$ {
      deny all;
      return 403;
  }

  location ~* \.(js|css|png|jpg|jpeg|gif|ico|woff)$ {
          expires 1w;
          log_not_found off;
  }

  location ~ \.php$ {
    try_files $uri =404;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass unix:/var/run/php5-fpm-$site_name.sock;
    client_max_body_size 0;
  }

  charset utf-8;
}

server {
  listen *:80;
  server_name www.meu.dominio.gov.br;
  return 301 $scheme://meu.dominio.gov.br$request_uri;
}
</code></pre>

<p>Crie o link para habilitar o virtual host</p>
<pre><code class="BASH">root@server# ln -s /etc/nginx/sites-available/mapas.conf /etc/nginx/sites-enabled/mapas.conf
</code></pre>

<p>Remover o arquivo default da pasta /etc/nginx/sites-available/</p>
<pre><code class="BASH">root@server# rm /etc/nginx/sites-available/default
</code></pre>

<h4 id="criando-pool-do-php-fpm">Criando pool do php-fpm</h4>
<p>Crie o arquivo <strong>/etc/php5/fpm/pool.d/mapas.conf</strong> com o conteúdo abaixo:</p>
<pre><code>[mapas]
listen = /var/run/php5-fpm-meu.dominio.gov.br.sock
listen.owner = mapas
listen.group = www-data
user = mapas
group = www-data
catch_workers_output = yes
pm = dynamic
pm.max_children = 10
pm.start_servers = 1
pm.min_spare_servers = 1
pm.max_spare_servers = 3
pm.max_requests = 500
chdir = /srv/mapas
; php_admin_value[open_basedir] = /srv/mapas:/tmp
php_admin_value[session.save_path] = /tmp/
; php_admin_value[error_log] = /var/log/mapasculturais/php.error.log
; php_admin_flag[log_errors] = on
php_admin_value[display_errors] = 'stderr'
</code></pre>

<h3 id="5-concluindo">5. Concluindo</h3>
<p>Para finalizar, precisamos popular o banco de dados com os dados iniciais e executar um script que entre outras coisas compila e minifica os assets, otimiza o autoload de classes do composer e roda atualizações do banco.</p>
<pre><code class="BASH">root@server# su - mapas
mapas@server$ psql -f mapasculturais/db/initial-data.sql
mapas@server$ ./mapasculturais/scripts/deploy.sh
</code></pre>

<p>Reinicie os serviços do <strong>nginx</strong> e <strong>php-fpm</strong></p>
<pre><code class="BASH">root@server# service nginx restart
root@server# service php5-fpm restart
</code></pre>

<h3 id="6-pos-instalacao-criando-super-admin">6. Pós-instalação - Criando super admin</h3>
<p>Para criar super usuários, é necessário mudar o status de um usuário já criado, deixando-o como superadmin. Você pode proceder da seguinte forma: </p>
<p>1 - Crie um usuário pelo painel;</p>
<p>2 - Entre no postgres e conecte-se na base. Caso esteja usando socket, basta que você esteja logado no terminal com o usuário do sistema em questão (se tiver seguido a documentação, esse usuário será o 'mapas') e digite psql. Isso irá mudar o terminal para:</p>
<p>$ mapas =&gt; </p>
<p>3 - Verifique o número do ID do usuário criado. Você pode ver pelo painel do mapas, na url do usuário ou ainda usar um select. </p>
<p>$ mapas =&gt; select id,status, email from usr where email='digite o endereço de email do usuário criado';</p>
<p>Quando executar essa linha você vai pegar o id. </p>
<p>4 - Dê um insert na tabela Role. </p>
<p>$ mapas =&gt; INSERT INTO role (usr_id, name) VALUES ($id_do_usuario, 'superAdmin'); </p>
<p>5 - Caso queira verificar o sucesso da ação, dê um select na tabela role.</p>
<p>$ mapas =&gt; select * from role;</p>
<h3 id="7-pos-instalacao-processo-de-autenticacao">7. Pós-instalação - Processo de autenticação</h3>
<p>O Mapas Culturais não tem um sistema próprio de autenticação, sendo seu funcionamento atrelado a um sistema de autenticação terceiro. Atualmente, dois sistemas de autenticação estão aptos e testados para essa tarefa: <a href="https://github.com/hacklabr/mapasculturais-openid">Mapas Culturais Open ID</a> e <a href="https://github.com/redelivre/login-cidadao">Login Cidadão</a>. </p>
<ul>
<li>Veja detalhes técnicos <a href="https://github.com/hacklabr/mapasculturais/blob/master/doc/developer-guide/config-auth.md">aqui</a></li>
</ul>
<h4 id="71-requisitos-para-implementacao-dos-sistemas-de-autenticacao">7.1 Requisitos para implementação dos sistemas de autenticação</h4>
<h5 id="mapas-open-id-conect">Mapas Open ID Conect</h5>
<p>Esté é um sistema em Python/Django e está ativo em algumas implementações, mas seu código tem pouca documentação e está descontinuado. Não recomenda-se a instalação com esse sistema a menos que o implementador possa contar com um time de desenvolvedores que impulsonem a retomada da ferramenta. 
Fonte:  https://github.com/hacklabr/mapasculturais-openid</p>
<h5 id="login-cidadao-instalacao-propria">Login Cidadão – Instalação própria</h5>
<p>O Login Cidadão é  um software que implementa um sistema de autenticação unificado em grande escala, unificando políticas de segurança, transparência e privacidade, e colocando o cidadão como ponto de convergência para a integração descentralizada dos dados e aplicações. Seu código é livre e é baseado, principalmente, no framework Symfony (php) </p>
<p><strong>Prós</strong></p>
<p>Os pontos positivos relativos aos aspectos de implementação de uma instalação própria são: 
<em> Confidencialidade dos dados e soberania: todos os dados estarão fisicamente em posse do implementador;
</em> Maior controle técnico de customização de layout e features. A posse desse customização, desde que com conhecimento adequado, é do implementador; </p>
<p><strong>Contras</strong>
<em> Necessidade de servidor próprio e dedicado a instalação;
</em> Manutenção com ônus financeiro uma vez que é necessário manter time (interno ou terceirizado) com conhecimentos técnicos adequado à operação técnica do software;
<em> Necessidade de endereço (url) dedicada e de certificado SSL implementado (o que também pode gerar custos uma vez 99% dos certificados são pagos anualmente);
</em> Comunidade pequena em torno do software, o que dificulta suporte espontâneo quando necessário;
<em> Versão 1.0 do software ainda não lançada;
</em> A aplicação não possui sistema de templates gerenciado via painel, o que gera necessidade de horas-técnicas para desenvolvimento/customização de tema no código;
* Documentação ainda incompleta, aumentando curva de aprendizado sobre o sistema; 
<strong>Fonte:</strong> https://github.com/redelivre/login-cidadao
<strong>Documentação de instalação e parametrização técnica:</strong> https://github.com/redelivre/login-cidadao/tree/master/doc (incompleto)
<strong>Documentação de operação:</strong> (inexistente)
<strong>Portal:</strong> http://logincidadao.org.br</p>
<h5 id="login-cidadao-federal-id-da-cultura">Login Cidadão Federal (ID da Cultura)</h5>
<p><strong>Prós</strong>
<em> Confidencialidade dos dados e soberania protegidas por uma entidade federal (Ministério da Cultura);
</em> Dispensa necessidade de servidor próprio e dedicado a instalação;
<em> Manutenção sem ônus financeiro uma vez que equipe do Departamento de Tecnologia da Informação do Ministério da Cultura incorpora em seu workflow de trabalho as demandas de atualização do sistema;
</em> Dispensa necessidade de endereço (url) dedicado e de certificado SSL próprio;</p>
<p><strong>Contras</strong>
<em> Menor controle técnico de customização de layout e features. A posse/soberania destas customização é do Ministério da Cultura e este deve ser acionado se necessário; 
</em> Para implementação, é necessário acionar equipe do Minc/DTI para criar uma entrada de origem do sistema, uma vez que os administradores são membros do DTI. No entanto esse processo é rápido e deve acontecer apenas uma vez, no inicio da instalação ou em momento esporádico de eventual manutenção do sistema. 
<strong>Fonte:</strong> http://id.cultura.gov.br/login</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../mc_deploy_theme/" class="btn btn-neutral float-right" title="Ativação do tema">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Sobre o Mapas Culturais"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../mc_deploy_theme/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
